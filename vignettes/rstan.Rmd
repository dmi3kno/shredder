---
title: "Working with rstan"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
stopifnot(require(knitr))
options(width = 90)
opts_chunk$set(
  comment = NA,
  message = FALSE,
  warning = FALSE,
  eval = TRUE,
  dev = "png",
  dpi = 150,
  fig.asp = 0.8,
  fig.width = 5,
  out.width = "60%",
  fig.align = "center"
)
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r example}
library(shredder)
library(rstan)
```

```{r,results='hide',warning=FALSE,message=FALSE}
rats <- shredder::rats_example(nCores = 1)
```

```{r,eval = FALSE}
rats
```

```{r,echo = FALSE}
rats%>%
  details::details(summary = 'Standard Output')
```

```{r,echo=FALSE}
details::details(system.file('rats.stan',package='shredder'),
                 summary = 'The Stan Script',lang = 'c')
```


## Pars

### Names

```{r}
rats%>%
  stan_names()

rats%>%
  stan_names(expand = TRUE)
```

### Select

```{r}
rats%>%
  stan_select(mu_alpha)

rats%>%
  stan_select(mu_alpha,mu_beta)

rats%>%
  stan_select(!!!rlang::syms(c('mu_alpha','mu_beta')))


rats%>%
  stan_select(alpha[1],alpha[2])


rats%>%
  stan_select(!!!rlang::syms(sprintf('alpha[%s]',1:5)))

```

### Select with Partials


```{r,eval=FALSE}
rats%>%
  stan_select(stan_contains('alpha'))

```

```{r,echo = FALSE}
rats%>%
  stan_select(stan_contains('alpha'))%>%
  details::details(summary = 'Select all Parameters that contain "alpha"')

```

```{r}
rats%>%
  stan_select(stan_contains('alpha\\[1\\]'))

rats%>%
  stan_select(stan_contains('alpha\\[[1-9]\\]'))

rats%>%
  stan_select(stan_ends_with('0'))

rats%>%
  stan_select(mu_alpha,stan_ends_with('0'),beta[1])
```

## Post-warmup samples

### Subsetting post warmup samples

```{r,eval=FALSE}

  rats%>%
    stan_slice(1:50,inc_warmup = TRUE)

```

```{r,echo=FALSE}

  rats%>%
    stan_slice(1:50,inc_warmup = TRUE)%>%
  details::details(summary = 'First 50 with warmup samples')

```

```{r,eval=FALSE}
  rats%>%
    stan_slice(1:50,inc_warmup = FALSE)

```


```{r,echo=FALSE}
  rats%>%
    stan_slice(1:50,inc_warmup = FALSE)%>%
  details::details(summary = 'First 50 draws from each chain <em>without</em> warmup samples')

```

```{r,eval=FALSE}
  rats%>%
    stan_sample_n(100)

```

```{r,echo=FALSE}
  rats%>%
    stan_sample_n(100)%>%
  details::details(summary = 'Sample 100 draws from each Chain')

```

```{r,eval=FALSE}

  rats%>%
    stan_sample_frac(0.5)

```

```{r,echo=FALSE}
rats%>%
    stan_sample_frac(0.5)%>%
    details::details(summary = 'Sample 50% of the Samples From each Chain')

```

### Select and Slice

```{r}
rats%>%
    stan_select(mu_alpha)%>%
    stan_slice(1:50)

```

### Keep Chains

```{r}
rats%>%
   stan_keep(chains = 1)
   
rats%>%
   stan_keep(chains = c(1,3))
```


### Filter

Users can filter conditionally on posterior samples in a chain, then those sample indicies will be removed from all the chains.

 > Be aware that there is an assumption of equal chain sizes in rstan summary functions. While it is possible to apply the filter within each chain this creates uneven chain sizes which breaks downstream rstan summary functions.

```{r}
rats%>%
   stan_select(mu_alpha,mu_beta)%>%
   stan_filter(mu_beta < 6)
 
```

To verify that the filter does work properly we can subset to a single chain and apply the filter.

```{r}
 rats%>%
   stan_keep(chains = 1)%>%
   stan_select(mu_alpha,mu_beta)%>%
   stan_filter(mu_beta < 6)
 
```
